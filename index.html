<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ライドシェアプラットフォーム</title>
</head>
<body>
  <h1>ライドシェアプラットフォームへようこそ！</h1>

  <!-- ユーザー登録フォーム -->
  <h2>登録</h2>
  <form id="register-form">
    <input type="text" id="register-name" placeholder="名前" required />
    <input type="email" id="register-email" placeholder="メールアドレス" required />
    <input type="password" id="register-password" placeholder="パスワード" required />
    <input type="text" id="register-studentId" placeholder="学生ID" required />
    <select id="register-userType" required>
      <option value="">役割を選択</option>
      <option value="driver">運転者</option>
      <option value="passenger">同乗者</option>
    </select>
    <button type="submit">登録</button>
  </form>
  <p id="register-message" style="color: green;"></p>

  <!-- ログインフォーム -->
  <h2>ログイン</h2>
  <form id="login-form">
    <input type="email" id="login-email" placeholder="メールアドレス" required />
    <input type="password" id="login-password" placeholder="パスワード" required />
    <button type="submit">ログイン</button>
  </form>
  <p id="error-message" style="color: red;"></p>

  <!-- ホーム画面 -->
  <div id="home-screen" style="display: none;">
    <h2>ホーム画面</h2>

    <!-- プロフィール編集欄 -->
    <h3>プロフィール編集</h3>
    <form id="edit-profile-form">
      <input type="text" id="edit-name" placeholder="名前" />
      <input type="email" id="edit-email" placeholder="メールアドレス" />
      <input type="text" id="edit-studentId" placeholder="学生ID" />
      <button type="submit">変更を保存</button>
    </form>
    <p id="edit-profile-message" style="color: green;"></p>

    <!-- ライド募集作成欄（運転者のみ） -->
    <h3>ライド募集作成 (運転者のみ)</h3>
    <form id="create-ride-form">
      <input type="text" id="ride-departure" placeholder="出発地" required />
      <input type="text" id="ride-destination" placeholder="目的地" required />
      <input type="datetime-local" id="ride-dateTime" required />
      <input type="number" id="ride-seats" placeholder="空き座席数" required min="1" />
      <button type="submit">募集を作成</button>
    </form>
    <p id="create-ride-message" style="color: green;"></p>

    <!-- 募集閲覧欄 -->
    <h3>利用可能なライド</h3>
    <div id="ride-list"></div>

    <!-- ログアウトボタン -->
    <button id="logout-button">ログアウト</button>
  </div>

  <script>
    // ページ読み込み時の処理
    window.onload = function () {
      const token = localStorage.getItem("token");
      if (token) {
        // トークンが存在する場合、ホーム画面を表示
        document.getElementById("home-screen").style.display = "block";
        document.getElementById("register-form").style.display = "none";
        document.getElementById("login-form").style.display = "none";
      } else {
        // トークンがない場合、登録・ログインフォームを表示
        document.getElementById("home-screen").style.display = "none";
        document.getElementById("register-form").style.display = "block";
        document.getElementById("login-form").style.display = "block";
      }
    };

    // 登録処理
    document.getElementById("register-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("register-name").value;
      const email = document.getElementById("register-email").value;
      const password = document.getElementById("register-password").value;
      const studentId = document.getElementById("register-studentId").value;
      const userType = document.getElementById("register-userType").value;

      const response = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, password, student_id: studentId, userType }),
      });

      const registerMessage = document.getElementById("register-message");
      if (response.ok) {
        registerMessage.textContent = "登録が成功しました！メールを確認して、アカウントを確認してください。";
      } else {
        const result = await response.json();
        registerMessage.textContent = result.message || "登録に失敗しました。";
        registerMessage.style.color = "red";
      }
    });

    // ログイン処理
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;

      const errorMessage = document.getElementById("error-message");
      errorMessage.textContent = "";

      const response = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });
      const result = await response.json();

      if (result.token) {
        alert("ログインが成功しました！");
        localStorage.setItem("token", result.token);
        document.getElementById("home-screen").style.display = "block";
        document.getElementById("register-form").style.display = "none";
        document.getElementById("login-form").style.display = "none";
      } else {
        errorMessage.textContent = result.message || "ログインに失敗しました。資格情報を確認してください。";
      }
    });

    // プロフィール編集処理
    document.getElementById("edit-profile-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("edit-name").value;
      const email = document.getElementById("edit-email").value;
      const studentId = document.getElementById("edit-studentId").value;

      const token = localStorage.getItem("token");
      const response = await fetch("/edit-profile", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ name, email, studentId }),
      });

      const editProfileMessage = document.getElementById("edit-profile-message");
      if (response.ok) {
        editProfileMessage.textContent = "プロフィールが正常に更新されました！";
      } else {
        editProfileMessage.textContent = "プロフィールの更新に失敗しました。";
      }
    });

    // ライド募集作成処理
    document.getElementById("create-ride-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const departure = document.getElementById("ride-departure").value;
      const destination = document.getElementById("ride-destination").value;
      const dateTime = document.getElementById("ride-dateTime").value;
      const seatsAvailable = document.getElementById("ride-seats").value;

      const token = localStorage.getItem("token");
      const response = await fetch("/create-ride-request", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ departure, destination, dateTime, seatsAvailable }),
      });

      const createRideMessage = document.getElementById("create-ride-message");
      if (response.ok) {
        createRideMessage.textContent = "ライド募集が作成されました！";
      } else {
        createRideMessage.textContent = "ライド募集の作成に失敗しました。";
      }
    });

    // 募集閲覧処理
    async function loadAvailableRides() {
      const response = await fetch("/search-rides");
      const rides = await response.json();
      const rideList = document.getElementById("ride-list");
      rideList.innerHTML = "";

      rides.forEach((ride) => {
        const rideItem = document.createElement("div");
        rideItem.textContent = `出発地: ${ride.departure} - 目的地: ${ride.destination} - 日時: ${ride.dateTime} - 空き座席数: ${ride.seatsAvailable}`;
        rideList.appendChild(rideItem);
      });
    }

    // ページ読み込み時に募集をロード
    window.onload = () => {
      const token = localStorage.getItem("token");
      if (token) {
        document.getElementById("home-screen").style.display = "block";
        document.getElementById("register-form").style.display = "none";
        document.getElementById("login-form").style.display = "none";
        loadAvailableRides();
      }
    };

    // ログアウト処理
    document.getElementById("logout-button").addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.reload();
    });
  </script>
</body>
</html>
